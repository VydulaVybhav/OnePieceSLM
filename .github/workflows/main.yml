name: Deploy to Local K8s

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted  # Uses your local runner
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Build Docker image
      run: |
        docker build -t streamlit-app:${{ github.sha }} .
        docker tag streamlit-app:${{ github.sha }} streamlit-app:latest

    - name: Deploy to Kubernetes
      run: |
        kubectl config use-context docker-desktop
        kubectl apply -f k8s/
        kubectl set image deployment/streamlit-app streamlit-app=streamlit-app:${{ github.sha }}
        kubectl rollout status deployment/streamlit-app
